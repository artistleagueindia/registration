<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Artist League Camp 2025 — Registration</title>
  <style>
    :root{--bg:#0b0b10;--card:#141420;--text:#f5f7ff;--muted:#a8acc3;--accent:#5b8cff;--ok:#1db954;--warn:#ffb020}
    body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:980px;margin:22px auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-sizing:border-box}
    h1{font-size:20px;margin:0 0 12px}
    label{display:block;font-size:13px;margin:10px 0 6px;color:var(--muted)}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a3a;background:#10101a;color:var(--text);box-sizing:border-box}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .coupon-bar{display:flex;gap:8px;align-items:center;margin-top:6px}
    .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;color:#fff;background:var(--accent)}
    .btn.secondary{background:#2a2a3a}
    .btn.ok{background:var(--ok)}
    .muted{color:var(--muted);font-size:13px}
    .calc{background:#0f1320;border:1px solid #2a314b;border-radius:12px;padding:12px;margin-top:12px}
    .calc .line{display:flex;justify-content:space-between;margin:6px 0}
    .calc .total{font-weight:700;font-size:18px}
    .okmsg{margin-top:12px;padding:10px;border-radius:10px;background:#0f1f14;border:1px solid #1e7d3b}
    .errmsg{margin-top:12px;padding:10px;border-radius:10px;background:#2a1414;border:1px solid #7d1e1e}
    .sidebar { color:var(--muted) }
    .logo { width:120px; height:auto; display:block; margin-bottom:12px }
    @media (max-width:940px){.grid{grid-template-columns:1fr}}
    
    /* QR Code Styles */
    .qr-container {
      display: none;
      margin-top: 20px;
      text-align: center;
      padding: 15px;
      background: #0f1320;
      border-radius: 12px;
      border: 1px solid #2a314b;
    }
    .qr-container.active {
      display: block;
    }
    .qr-code {
      margin: 15px auto;
      padding: 10px;
      background: white;
      border-radius: 8px;
      display: inline-block;
    }
    .qr-code img {
      display: block;
    }
    .qr-info {
      margin-top: 10px;
      font-size: 14px;
    }
    .qr-amount {
      font-weight: bold;
      color: var(--ok);
      font-size: 18px;
      margin: 10px 0;
    }
    .qr-note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }
    .qr-upi-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 12px;
      background: var(--accent);
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }
    .qr-upi-link:hover {
      background: #4a7ce8;
    }
    
    /* Registration Complete Styles */
    .registration-complete {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #0f1f14;
      border: 1px solid #1e7d3b;
      border-radius: 12px;
      text-align: center;
    }
    .registration-complete.active {
      display: block;
    }
    .registration-complete h2 {
      color: var(--ok);
      margin-top: 0;
    }
    .registration-complete p {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- LEFT: form -->
    <div class="card">
      <h1>Artist League Camp 2025 — Registration</h1>
      <form id="regForm" autocomplete="on" novalidate>
        <div class="row">
          <div>
            <label for="name">Name</label>
            <input id="name" name="name" required />
          </div>
          <div>
            <label for="age">Age</label>
            <input id="age" name="age" type="number" min="5" max="99" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="city">Current City</label>
            <input id="city" name="city" placeholder="" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" inputmode="tel" pattern="[0-9]{10,}" title="Enter at least 10 digits" placeholder="10+ digits" required />
          </div>
          <div>
            <label for="insta">Instagram Profile Link</label>
            <input id="insta" name="insta" placeholder="https://instagram.com/…" />
          </div>
        </div>
        <label for="cop">City of Participation</label>
        <select id="cop" name="cop" required>
          <option value="">Choose…</option>
          <option value="MUMBAI">Mumbai</option>
          <option value="PUNE">Pune</option>
        </select>
        <label for="package">Choose package</label>
        <select id="package" name="package" required>
          <option value="FULL_CAMP">Full camp — ₹8499</option>
          <option value="8_CLASSES">8 classes — ₹7699</option>
          <option value="7_CLASSES">7 classes — ₹6799</option>
          <option value="6_CLASSES">6 classes — ₹5799</option>
          <option value="5_CLASSES">5 classes — ₹4799</option>
          <option value="4_CLASSES">4 classes — ₹3899</option>
          <option value="3_CLASSES">3 classes — ₹2999</option>
          <option value="2_CLASSES">2 classes — ₹2199</option>
          <option value="SINGLE_CLASS">Single class — ₹1200</option>
          <option value="AKSHAY_STAG">Akshay x Manvi (Stag) — ₹1199</option>
          <option value="AKSHAY_COUPLE">Akshay x Manvi (Couple) — ₹1999</option>
        </select>
        <label>Coupon Code (optional)</label>
        <div class="coupon-bar">
          <input id="coupon" name="coupon" placeholder="" />
          <button class="btn" type="button" id="applyBtn">Apply</button>
        </div>
        <div class="muted" style="margin-top:6px">Coupon list is private and validated server-side. Coupons apply only to full camp.</div>
        <div class="calc" id="calcBox">
          <div class="line"><span>Total fee</span><span>₹ <span id="totalFee">8499</span></span></div>
          <div class="line"><span>Discount</span><span>- ₹ <span id="discountAmt">0</span></span></div>
          <div class="line total"><span>Amount payable</span><span>₹ <span id="payAmt">8499</span></span></div>
        </div>
        <div class="okmsg" id="okMsg" style="display:none;"></div>
        <div class="errmsg" id="errMsg" style="display:none;"></div>
        
        <!-- QR Code Container -->
        <div id="qrContainer" class="qr-container">
          <h3>Complete Your Payment</h3>
          <p>Scan the QR code below to pay the registration fee</p>
          <div class="qr-amount">Amount: ₹<span id="qrAmount">8499</span></div>
          <div class="qr-code">
            <img id="qrImage" src="" alt="Payment QR Code" />
          </div>
          <div class="qr-info">
            <p>Pay to: <strong>Artist League</strong></p>
            <p>UPI ID: <strong>yashmani1996@okhdfcbank</strong></p>
            <a id="qrUpiLink" href="#" target="_blank" class="qr-upi-link">Pay via UPI App</a>
          </div>
          <p class="qr-note">After payment, please take a screenshot and upload it using the button below.</p>
          <button id="screenshotBtn" class="btn ok" type="button">Upload Payment Screenshot</button>
        </div>
        
        <!-- Registration Complete Message -->
        <div id="registrationComplete" class="registration-complete">
          <h2>Registration Complete!</h2>
          <p>Thank you for your payment and registration.</p>
          <p>Please check your email for confirmation details.</p>
        </div>
        
        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button id="payBtn" class="btn" type="button">Pay</button>
          <button class="btn secondary" type="button" id="resetBtn">Reset</button>
        </div>
      </form>
    </div>
    <!-- RIGHT: sidebar -->
    <div class="card sidebar">
      <!-- logo placeholder: paste your logo into src when ready -->
      <img id="logo" class="logo" src="" alt="Artist League logo" style="display:none">
      <h1 style="font-size:16px;margin-top:0">Registration Summary</h1>
      <div class="calc" style="margin-top:6px">
        <div class="line"><span>Applied coupon</span><span id="appliedTag">—</span></div>
        <div class="line"><span>Payable now</span><span>₹ <span id="sidePay">8499</span></span></div>
      </div>
      <h2 style="margin-top:18px">About us</h2>
      <p>Artist League — community-first live art education experiences across India.</p>
      <h2 style="margin-top:12px">Terms & policies</h2>
      <p>By registering you agree to our Terms & Conditions. Registrations are final — no refunds. Organizer may cancel or reschedule events; in such case a credit or alternate arrangement may be offered.</p>
      <h2 style="margin-top:12px">Contact</h2>
      <p style="margin-bottom:4px">Email: artistleagueindia@gmail.com</p>
      <p>Phone: +91 9837816447</p>
    </div>
  </div>
</div>
<script>
/* ================= CONFIG - set your Apps Script webapp exec URL here ================= */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbz5tJslGTr1_xV7j-b_8uNTNvtGXNq8TFwZPNm5AoAenOokeFrWG7Li6_6gY_fjl5nLvA/exec'; // Update this with your web app URL
const GOOGLE_FORM_URL = 'https://forms.gle/KX75aQhdpPFk7BLo7';
const MAIN_PAGE_URL = 'https://artistleagueindia.github.io/registration/'; // Update this with your web app URL

/* UPI Payment Configuration */
const UPI_CONFIG = {
  ID: 'yashmani1996@okhdfcbank',
  NAME: 'Artist League',
  NOTE: 'Registration Fee'
};

/* Replace the old PACKAGE_PRICING with this (all keys that start with digits are quoted) */
const PACKAGE_PRICING = {
  "FULL_CAMP": 8499,
  "8_CLASSES": 7699,
  "7_CLASSES": 6799,
  "6_CLASSES": 5799,
  "5_CLASSES": 4799,
  "4_CLASSES": 3899,
  "3_CLASSES": 2999,
  "2_CLASSES": 2199,
  "SINGLE_CLASS": 1200,
  "AKSHAY_STAG": 1199,
  "AKSHAY_COUPLE": 1999
};

const totalFeeEl = document.getElementById('totalFee');
const discountEl = document.getElementById('discountAmt');
const payAmtEl = document.getElementById('payAmt');
const sidePayEl = document.getElementById('sidePay');
const appliedTag = document.getElementById('appliedTag');
const applyBtn = document.getElementById('applyBtn');
const couponInput = document.getElementById('coupon');
const packageSel = document.getElementById('package');
const okMsg = document.getElementById('okMsg');
const errMsg = document.getElementById('errMsg');
const payBtn = document.getElementById('payBtn');
const resetBtn = document.getElementById('resetBtn');
const screenshotBtn = document.getElementById('screenshotBtn');
const logoImg = document.getElementById('logo');
const qrContainer = document.getElementById('qrContainer');
const qrImage = document.getElementById('qrImage');
const qrAmount = document.getElementById('qrAmount');
const qrUpiLink = document.getElementById('qrUpiLink');
const registrationComplete = document.getElementById('registrationComplete');
let couponApplied = false;
let couponCodeApplied = '';
let currentFinal = PACKAGE_PRICING.FULL_CAMP;
let orderId = '';

// init UI
function updateAmountUI(){
  const pkg = packageSel.value || 'FULL_CAMP';
  const price = PACKAGE_PRICING[pkg] || PACKAGE_PRICING.FULL_CAMP;
  totalFeeEl.textContent = price;
  if(couponApplied){
    const discount = (PACKAGE_PRICING.FULL_CAMP - currentFinal);
    discountEl.textContent = discount > 0 ? discount : '0';
    payAmtEl.textContent = currentFinal;
    sidePayEl.textContent = currentFinal;
    appliedTag.textContent = couponCodeApplied.toUpperCase();
  } else {
    discountEl.textContent = '0';
    payAmtEl.textContent = price;
    sidePayEl.textContent = price;
    appliedTag.textContent = '—';
  }
  
  // Update QR amount if QR is visible
  if (qrContainer.classList.contains('active')) {
    updateQrCode();
  }
}

// Generate UPI payment string
function generateUpiString(amount) {
  return `upi://pay?pa=${UPI_CONFIG.ID}&pn=${encodeURIComponent(UPI_CONFIG.NAME)}&am=${amount}&cu=INR&tn=${encodeURIComponent(UPI_CONFIG.NOTE)}`;
}

// Update QR code with current amount
function updateQrCode() {
  const amount = currentFinal;
  const upiString = generateUpiString(amount);
  const qrSize = 200;
  const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=${qrSize}x${qrSize}&data=${encodeURIComponent(upiString)}`;
  
  qrImage.src = qrUrl;
  qrAmount.textContent = amount;
  qrUpiLink.href = upiString;
}

// Show QR code
function showQrCode() {
  updateQrCode();
  qrContainer.classList.add('active');
  screenshotBtn.disabled = false;
  window.scrollTo(0, qrContainer.offsetTop);
}

// Hide QR code
function hideQrCode() {
  qrContainer.classList.remove('active');
  screenshotBtn.disabled = true;
}

// Show registration complete message
function showRegistrationComplete() {
  hideQrCode();
  registrationComplete.classList.add('active');
  window.scrollTo(0, registrationComplete.offsetTop);
}

// Hide registration complete message
function hideRegistrationComplete() {
  registrationComplete.classList.remove('active');
}

// message helpers
function hideMsgs(){ okMsg.style.display='none'; errMsg.style.display='none'; }
function showOk(txt){ okMsg.textContent = txt; okMsg.style.display='block'; errMsg.style.display='none'; }
function showError(txt){ errMsg.textContent = txt; errMsg.style.display='block'; okMsg.style.display='none'; }

// package change updates price and resets coupon (coupon only for FULL_CAMP)
packageSel.addEventListener('change', () => {
  couponApplied = false;
  couponCodeApplied = '';
  currentFinal = PACKAGE_PRICING[packageSel.value] || PACKAGE_PRICING.FULL_CAMP;
  updateAmountUI();
  hideMsgs();
  hideQrCode();
  hideRegistrationComplete();
});

// reset
resetBtn.addEventListener('click', () => {
  document.getElementById('regForm').reset();
  couponApplied = false; couponCodeApplied = '';
  currentFinal = PACKAGE_PRICING.FULL_CAMP;
  updateAmountUI();
  hideMsgs();
  hideQrCode();
  hideRegistrationComplete();
  screenshotBtn.disabled = true;
  payBtn.disabled = false;
  payBtn.textContent = 'Pay';
});

// apply coupon (server-side validation)
applyBtn.addEventListener('click', async () => {
  hideMsgs();
  hideQrCode();
  hideRegistrationComplete();
  const code = (couponInput.value || '').trim();
  const pkg = packageSel.value || 'FULL_CAMP';
  const email = (document.getElementById('email').value || '').trim();
  if(!code){ showError('Enter a coupon code to apply.'); return; }
  if(pkg !== 'FULL_CAMP'){ showError('Coupons apply only to Full camp registrations.'); return; }
  if(!email){ showError('Enter email first (coupon validation needs your email).'); return; }
  try{
    applyBtn.disabled = true;
    applyBtn.textContent = 'Checking...';
    const resp = await fetch(`${WEB_APP_URL}?action=validateCoupon&coupon=${encodeURIComponent(code)}&package=${encodeURIComponent(pkg)}&email=${encodeURIComponent(email)}`, { method:'GET' });
    const json = await resp.json();
    if(!json || !json.ok){ throw new Error(json && json.error ? json.error : 'Invalid response'); }
    if(json.valid){
      couponApplied = true;
      couponCodeApplied = code.toUpperCase();
      currentFinal = json.finalAmount || PACKAGE_PRICING.FULL_CAMP - 2000;
      updateAmountUI();
      showOk('Coupon applied. Amount updated.');
    } else {
      couponApplied = false; couponCodeApplied = '';
      currentFinal = PACKAGE_PRICING.FULL_CAMP;
      updateAmountUI();
      showError(json.message || 'Coupon invalid or already used.');
    }
  }catch(err){
    console.error('coupon check error', err);
    showError('Coupon validation failed. Try again.');
  }finally{
    applyBtn.disabled = false;
    applyBtn.textContent = 'Apply';
  }
});

// basic client validation before payment
function validateFormBeforePayment(){
  const name = (document.getElementById('name').value || '').trim();
  const email = (document.getElementById('email').value || '').trim();
  const cop = (document.getElementById('cop').value || '').trim();
  const phone = (document.getElementById('phone').value || '').trim();
  if(!name || !email || !cop || !phone){ showError('Please complete Name, Email, Phone and City of Participation before paying.'); return false; }
  if(!/^\d{10,}$/.test(phone)){ showError('Enter valid phone (10+ digits).'); return false; }
  hideMsgs();
  return true;
}

// submit form to Apps Script backend (x-www-form-urlencoded)
async function submitFormToServer(){
  hideMsgs();
  payBtn.disabled = true;
  const origText = payBtn.textContent;
  payBtn.textContent = 'Processing...';
  const params = new URLSearchParams();
  params.append('name', (document.getElementById('name').value || '').trim());
  params.append('age', (document.getElementById('age').value || '').trim());
  params.append('city', (document.getElementById('city').value || '').trim());
  params.append('email', (document.getElementById('email').value || '').trim());
  params.append('phone', (document.getElementById('phone').value || '').trim());
  params.append('insta', (document.getElementById('insta').value || '').trim());
  params.append('cop', (document.getElementById('cop').value || '').trim());
  params.append('package', (packageSel.value || 'FULL_CAMP'));
  params.append('coupon', (couponApplied ? couponCodeApplied : ''));
  params.append('couponApplied', (couponApplied ? '1' : '0'));
  try {
    const res = await fetch(WEB_APP_URL, {
      method:'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString()
    });
    const text = await res.text();
    // try parse JSON
    let json;
    try { json = JSON.parse(text); } catch(e) {
      throw new Error('Server returned non-JSON response. Check deployment & logs.\nPreview: ' + text.slice(0,2000));
    }
    if(!json.ok) throw new Error(json.error || 'Submission failed on server.');
    
    // Store order ID for later use
    orderId = json.orderId || '';
    
    showOk('Registration initiated! Order ID: ' + orderId);
    payBtn.disabled = true;
    payBtn.textContent = 'Registered';
    
    // Show QR code for payment
    showQrCode();
    
    return json;
  } catch(err){
    console.error('submit error', err);
    showError('Submission failed: ' + (err.message || err));
    throw err;
  } finally {
    if(payBtn.textContent !== 'Registered'){
      payBtn.disabled = false;
      payBtn.textContent = origText || 'Pay';
    }
  }
}

// Open Google Form for uploading screenshot with redirect back to main page
function openScreenshotForm() {
  // Create a URL that will redirect back to main page after submission
  const name = (document.getElementById('name').value || '').trim();
  const phone = (document.getElementById('phone').value || '').trim();
  const email = (document.getElementById('email').value || '').trim();
  
  // Since we don't have entry IDs, we'll use the field names directly
  // Google Forms will automatically map these to the correct fields
  const redirectUrl = `${GOOGLE_FORM_URL}?usp=pp_url&Name=${encodeURIComponent(name)}&Phone=${encodeURIComponent(phone)}&Email=${encodeURIComponent(email)}&Order+ID=${encodeURIComponent(orderId)}`;
  
  // Open in new tab
  window.open(redirectUrl, '_blank');
}

// Check if registration is complete (this would be called when returning from the form)
function checkRegistrationComplete() {
  // In a real implementation, you would check the server to see if the payment has been verified
  // For this example, we'll simulate it with a timeout
  showRegistrationComplete();
}

// Pay button click handler
async function handlePayment(){
  if(!validateFormBeforePayment()) return;
  try {
    await submitFormToServer();
  } catch(err){
    console.error('handlePayment error', err);
    showError('Registration error: ' + (err.message || err));
  }
}

// Wire buttons
if(payBtn){
  payBtn.addEventListener('click', (ev) => { ev.preventDefault(); handlePayment(); });
} else {
  console.warn('Pay button missing (id=payBtn).');
}

if(screenshotBtn){
  screenshotBtn.addEventListener('click', (ev) => { ev.preventDefault(); openScreenshotForm(); });
} else {
  console.warn('Screenshot button missing (id=screenshotBtn).');
}

// Check if we're returning from the form submission
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('formSubmitted') === 'true') {
  checkRegistrationComplete();
}

// init amounts
(function init(){
  currentFinal = PACKAGE_PRICING.FULL_CAMP;
  updateAmountUI();
})();
</script>
</body>
</html>
