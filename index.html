<!-- index.html -->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Artist League Camp 2025 — Registration</title>
<style>
  :root{--bg:#0b0b10;--card:#141420;--text:#f5f7ff;--muted:#a8acc3;--accent:#5b8cff;--ok:#1db954;--warn:#ffb020}
  body{margin:0;font-family:Inter,system-ui,Arial;background:var(--bg);color:var(--text)}
  .wrap{max-width:980px;margin:22px auto;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  .card{background:var(--card);border-radius:16px;padding:18px;box-sizing:border-box}
  h1{font-size:20px;margin:0 0 12px}
  label{display:block;font-size:13px;margin:10px 0 6px;color:var(--muted)}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a3a;background:#10101a;color:var(--text);box-sizing:border-box}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .coupon-bar{display:flex;gap:8px;align-items:center;margin-top:6px}
  .btn{padding:10px 14px;border:0;border-radius:10px;cursor:pointer;color:#fff;background:var(--accent)}
  .btn.secondary{background:#2a2a3a}
  .btn.ok{background:var(--ok)}
  .muted{color:var(--muted);font-size:13px}
  .calc{background:#0f1320;border:1px solid #2a314b;border-radius:12px;padding:12px;margin-top:12px}
  .calc .line{display:flex;justify-content:space-between;margin:6px 0}
  .calc .total{font-weight:700;font-size:18px}
  .okmsg{margin-top:12px;padding:10px;border-radius:10px;background:#0f1f14;border:1px solid #1e7d3b}
  .errmsg{margin-top:12px;padding:10px;border-radius:10px;background:#2a1414;border:1px solid #7d1e1e}
  .file-info{font-size:13px;color:var(--muted);margin-top:8px}
  @media (max-width:940px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <!-- LEFT: form -->
    <div class="card">
      <h1>Artist League Camp 2025 — Registration</h1>
      <form id="regForm" autocomplete="on" novalidate>
        <div class="row">
          <div>
            <label for="name">Name</label>
            <input id="name" name="name" required />
          </div>
          <div>
            <label for="age">Age</label>
            <input id="age" name="age" type="number" min="5" max="99" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="city">Current City</label>
            <input id="city" name="city" placeholder="" />
          </div>
          <div>
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="phone">Phone</label>
            <input id="phone" name="phone" inputmode="tel" pattern="[0-9]{7,}" title="Enter phone digits" />
          </div>
          <div>
            <label for="insta">Instagram Profile Link</label>
            <input id="insta" name="insta" placeholder="https://instagram.com/…" />
          </div>
        </div>

        <label for="cop">City of Participation</label>
        <select id="cop" name="cop" required>
          <option value="">Choose…</option>
          <option value="MUMBAI">Mumbai</option>
          <option value="PUNE">Pune</option>
        </select>

        <label for="package">Choose package</label>
        <select id="package" name="package" required>
          <option value="FULL">Full camp — ₹8499</option>
          <option value="8CLASSES">8 classes — ₹7699</option>
          <option value="7CLASSES">7 classes — ₹6799</option>
          <option value="6CLASSES">6 classes — ₹5799</option>
          <option value="5CLASSES">5 classes — ₹4799</option>
          <option value="4CLASSES">4 classes — ₹3899</option>
          <option value="3CLASSES">3 classes — ₹2999</option>
          <option value="2CLASSES">2 classes — ₹2199</option>
          <option value="SINGLE">Single class — ₹1200</option>
          <option value="AKSHAY_STAG">Akshay x Manvi (Stag) — ₹1199</option>
          <option value="AKSHAY_COUPLE">Akshay x Manvi (Couple) — ₹1999</option>
        </select>

        <label>Coupon Code (optional)</label>
        <div class="coupon-bar">
          <input id="coupon" name="coupon" placeholder="" />
          <button class="btn" type="button" id="applyBtn">Apply</button>
        </div>
        <div class="muted" style="margin-top:6px">Coupon list is private and validated server-side. Coupons apply only to Full camp.</div>

        <div class="calc" id="calcBox">
          <div class="line"><span>Total fee</span><span>₹ <span id="totalFee">8499</span></span></div>
          <div class="line"><span>Discount</span><span>- ₹ <span id="discountAmt">0</span></span></div>
          <div class="line total"><span>Amount payable</span><span>₹ <span id="payAmt">8499</span></span></div>
        </div>

        <div class="okmsg" id="okMsg" style="display:none;"></div>
        <div class="errmsg" id="errMsg" style="display:none;"></div>

        <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" type="button" id="payBtn">Pay</button>
          <button class="btn secondary" type="button" id="resetBtn">Reset</button>
        </div>
      </form>
    </div>

    <!-- RIGHT: info -->
    <div class="card">
      <h1>Pay via PhonePe (or gateway)</h1>

      <div class="calc" style="margin-top:12px">
        <div class="line"><span>Applied coupon</span><span id="appliedTag">—</span></div>
        <div class="line"><span>Payable now</span><span>₹ <span id="sidePay">8499</span></span></div>
      </div>

      <h2 style="margin-top:18px">About us</h2>
      <p class="muted">Artist League — community-first live art education experiences across India. Practical workshops & multi-day camps led by working artists. (Full bio will be included in official pages and admin emails.)</p>

      <h2 style="margin-top:12px">Terms & policies</h2>
      <p class="muted">By registering you agree to Terms & Conditions (no refunds). Full policies are emailed on completion.</p>

      <h2 style="margin-top:12px">Contact</h2>
      <p class="muted">Email: artistleagueindia@gmail.com<br>Phone: +91 98378 16447</p>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG - set your deployed webapp URL here ===== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby4KZSoda-cIQutHlG88MtuoEdpgB2uafKLvxhRk8wcD2tDMrTUUPEOL5BUBeGwSrS1/exec';
/* ==================================================== */

const PACKAGES = {
  'FULL': { label: 'Full camp', amount: 8499 },
  '8CLASSES': { label: '8 classes', amount: 7699 },
  '7CLASSES': { label: '7 classes', amount: 6799 },
  '6CLASSES': { label: '6 classes', amount: 5799 },
  '5CLASSES': { label: '5 classes', amount: 4799 },
  '4CLASSES': { label: '4 classes', amount: 3899 },
  '3CLASSES': { label: '3 classes', amount: 2999 },
  '2CLASSES': { label: '2 classes', amount: 2199 },
  'SINGLE': { label: 'Single class', amount: 1200 },
  'AKSHAY_STAG': { label: 'Akshay x Manvi (Stag)', amount: 1199 },
  'AKSHAY_COUPLE': { label: 'Akshay x Manvi (Couple)', amount: 1999 }
};

const totalFeeEl = document.getElementById('totalFee');
const discountEl = document.getElementById('discountAmt');
const payAmtEl = document.getElementById('payAmt');
const sidePayEl = document.getElementById('sidePay');
const appliedTag = document.getElementById('appliedTag');
const applyBtn = document.getElementById('applyBtn');
const couponInput = document.getElementById('coupon');
const packageSelect = document.getElementById('package');
const payBtn = document.getElementById('payBtn');
const resetBtn = document.getElementById('resetBtn');
const okMsg = document.getElementById('okMsg');
const errMsg = document.getElementById('errMsg');

let currentFinal = PACKAGES['FULL'].amount;
let couponApplied = false;
let appliedCouponCode = '';

function hideMsgs(){ okMsg.style.display='none'; errMsg.style.display='none'; }
function showOk(txt){ okMsg.textContent = txt; okMsg.style.display='block'; errMsg.style.display='none'; }
function showError(txt){ errMsg.textContent = txt; errMsg.style.display='block'; okMsg.style.display='none'; }

function updateAmounts() {
  const pkg = packageSelect.value;
  const base = PACKAGES[pkg].amount;
  totalFeeEl.textContent = base;
  if (couponApplied && pkg === 'FULL') {
    const discount = base - currentFinal;
    discountEl.textContent = discount;
    payAmtEl.textContent = currentFinal;
    sidePayEl.textContent = currentFinal;
    appliedTag.textContent = appliedCouponCode.toUpperCase();
  } else {
    discountEl.textContent = 0;
    payAmtEl.textContent = base;
    sidePayEl.textContent = base;
    appliedTag.textContent = '—';
  }
}

// coupon apply -> call server to validate
applyBtn.addEventListener('click', async () => {
  hideMsgs();
  const code = (couponInput.value || '').trim();
  const pkg = packageSelect.value;
  if (!code) { showError('Enter a coupon code to apply.'); return; }
  try {
    applyBtn.disabled = true; applyBtn.textContent = 'Checking...';
    const resp = await fetch(`${WEB_APP_URL}?action=validateCoupon&coupon=${encodeURIComponent(code)}&packageKey=${encodeURIComponent(pkg)}`, { method:'GET' });
    const j = await resp.json();
    if (!j.ok) throw new Error(j.error || 'Invalid response');
    if (j.valid) {
      couponApplied = true;
      appliedCouponCode = code;
      currentFinal = j.finalAmount;
      showOk('Coupon applied.');
    } else {
      couponApplied = false;
      appliedCouponCode = '';
      currentFinal = PACKAGES[pkg].amount;
      showError(j.reason || 'Invalid coupon');
    }
    updateAmounts();
  } catch (err) {
    console.error(err);
    showError('Coupon validation failed.');
  } finally {
    applyBtn.disabled = false; applyBtn.textContent = 'Apply';
  }
});

// change package -> reset coupon if not allowed
packageSelect.addEventListener('change', () => {
  // if coupon only for full and user switched away, remove coupon
  if (couponApplied && packageSelect.value !== 'FULL') {
    couponApplied = false;
    appliedCouponCode = '';
    showError('Coupon removed (only valid for Full camp).');
  } else {
    hideMsgs();
  }
  currentFinal = couponApplied ? currentFinal : PACKAGES[packageSelect.value].amount;
  updateAmounts();
});

resetBtn.addEventListener('click', () => {
  document.getElementById('regForm').reset();
  couponApplied = false;
  appliedCouponCode = '';
  currentFinal = PACKAGES['FULL'].amount;
  updateAmounts();
  hideMsgs();
});

// create order -> open payment -> poll order status
payBtn.addEventListener('click', async () => {
  hideMsgs();
  payBtn.disabled = true; payBtn.textContent = 'Processing...';

  // basic validation
  const name = document.getElementById('name').value.trim();
  const email = document.getElementById('email').value.trim();
  const cop = document.getElementById('cop').value.trim();
  if (!name || !email || !cop) {
    showError('Please complete name, email and city of participation.');
    payBtn.disabled = false; payBtn.textContent = 'Pay';
    return;
  }

  const payload = {
    action: 'createOrder',
    name: name,
    age: document.getElementById('age').value || '',
    city: document.getElementById('city').value || '',
    email: email,
    phone: document.getElementById('phone').value || '',
    insta: document.getElementById('insta').value || '',
    cop: cop,
    packageKey: packageSelect.value,
    coupon: couponInput.value.trim()
  };

  try {
    const res = await fetch(WEB_APP_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const contentType = res.headers.get('content-type') || '';
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || 'Order creation failed');
    const orderId = data.orderId;
    const amount = data.amount;
    // open payment page (simulator or real gateway)
    const win = window.open(data.paymentUrl, '_blank');
    showOk('Order created. Waiting for payment confirmation... (Order ID: ' + orderId + ')');

    // poll for order status
    const poll = async () => {
      try {
        const s = await fetch(WEB_APP_URL + '?action=orderStatus&orderId=' + encodeURIComponent(orderId));
        const sj = await s.json();
        if (sj.ok && sj.status === 'PAID') {
          showOk('Payment received. Registration complete. Check your email for confirmation. Order ID: ' + orderId);
          payBtn.disabled = true; payBtn.textContent = 'Paid';
          return true;
        }
        if (sj.ok && (sj.status === 'FAILED' || sj.status === 'CANCELLED')) {
          showError('Payment failed. Please retry.');
          payBtn.disabled = false; payBtn.textContent = 'Pay';
          return true;
        }
      } catch (err) {
        console.error('poll error', err);
      }
      return false;
    };

    // poll every 3 seconds (stop after 80 seconds)
    let attempts = 0, done = false;
    while (!done && attempts < 30) {
      await new Promise(r => setTimeout(r, 3000));
      done = await poll();
      attempts++;
    }
    if (!done) {
      showError('Could not confirm payment yet. Please check your email later or contact support.');
      payBtn.disabled = false; payBtn.textContent = 'Pay';
    }
  } catch (err) {
    console.error('createOrder error', err);
    showError('Submission failed: ' + (err.message || err));
    payBtn.disabled = false; payBtn.textContent = 'Pay';
  }
});

updateAmounts();
</script>
</body>
</html>

